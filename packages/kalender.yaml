# packages/kalender.yaml
# -------------------------------------------------------------------
# Package: Kalender
# Zweck:   Ruft iCloud Kalender ab.
# -------------------------------------------------------------------

# 1) INTEGRATIONEN
calendar:
  - platform: caldav
    username: !secret userIcloud
    password: !secret passIcloud
    url: https://caldav.icloud.com

# >>> PASTE: BEGIN integration <<<
# <Integration(en) hier einfügen>
# >>> PASTE: END integration <<<

# 2) TEMPLATE-SENSOREN UND BINARY-SENSOREN
template:
  - trigger:
      trigger: time_pattern
      minutes: /30 # aktualisiert alle 30 Minuten
    action:
      - action: calendar.get_events
        target:
          entity_id: calendar.abfall
        data:
          start_date_time: "{{ (now().date() + timedelta(days=0)).isoformat() }}T06:00:00"
          duration:
            hours: 18
            minutes: 0
            seconds: 0
        response_variable: agenda
      - variables:
          events: "{{ agenda['calendar.abfall']['events'] }}"
    sensor:
      - name: "Abfalltermine Heute"
        unique_id: trash_calendar_events_today
        state: >
          {%- set summaries = events | map(attribute='summary') | list -%}
          {{ summaries | join(' + ') if summaries else '-' }}
        attributes:
          count: "{{ summaries | count }}"
          titles: "{{ summaries }}"
  - trigger:
      trigger: time_pattern
      minutes: /30 # alle 30 Minuten aktualisieren
    action:
      - action: calendar.get_events
        target:
          entity_id: calendar.abfall
        data:
          start_date_time: "{{ (now().date() + timedelta(days=1)).isoformat() }}T06:00:00"
          duration:
            hours: 18
            minutes: 0
            seconds: 0
        response_variable: agenda
      - variables:
          events: "{{ agenda['calendar.abfall']['events'] }}"
    sensor:
      - name: "Abfalltermine Morgen"
        unique_id: trash_calendar_events_tomorrow
        state: >
          {%- set summaries = events | map(attribute='summary') | list -%}
          {{ summaries | join(' + ') if summaries else '-' }}
        attributes:
          count: "{{ summaries | count }}"
          titles: "{{ summaries }}"
# >>> PASTE: BEGIN templates <<<
# <Templates hier einfügen>
# >>> PASTE: END templates <<<

# 3) AUTOMATIONEN
# Alle themenspezifischen Automationen können hier direkt definiert werden.
#
# Beispiel:
# automation:
#   - id: <eindeutige_id>
#     alias: "<Sprechender Name>"
#     mode: single
#     trigger:
#       - platform: time
#         at: "07:00:00"
#     action:
#       - action: light.turn_on
#         target:
#           entity_id: light.schlafzimmer

# >>> PASTE: BEGIN automations <<<
# <Automationen hier einfügen>
# >>> PASTE: END automations <<<

# 4) SCRIPTS
# Falls es Skripte für dieses Thema gibt.
#
# Beispiel:
# script:
#   beispiel_script:
#     alias: "Beispiel Script"
#     sequence:
#       - action: notify.mobile_app_handys
#         data:
#           message: "Script ausgeführt"

# >>> PASTE: BEGIN scripts <<<
# <Skripte hier einfügen>
# >>> PASTE: END scripts <<<

# 5) HELFER (input_boolean, input_number, input_select, input_datetime)
# Hilfsobjekte, die nur für dieses Thema genutzt werden.
#
# Beispiel:
# input_boolean:
#   beispiel_schalter:
#     name: "Beispiel Schalter"

# >>> PASTE: BEGIN helpers <<<
# <Helfer hier einfügen>
# >>> PASTE: END helpers <<<

# 6) SCENES
# Szenen, die thematisch dazugehören.
#
# Beispiel:
# scene:
#   - id: beispiel_szene
#     name: "Beispiel Szene"
#     entities:
#       light.schlafzimmer:
#         state: "on"
#         brightness: 200

# >>> PASTE: BEGIN scenes <<<
# <Szenen hier einfügen>
# >>> PASTE: END scenes <<<

# 7) CUSTOMIZE
# Falls Entitäten angepasst werden müssen (Name, Icon, Attribute).
# Dies ist nur innerhalb dieses Pakets wirksam.
#
# Beispiel:
# homeassistant:
#   customize:
#     sensor.beispiel_temp:
#       icon: mdi:thermometer

# >>> PASTE: BEGIN customize <<<
# <Customize hier einfügen>
# >>> PASTE: END customize <<<
