# ---------------------------------------------------------
# Base / Boot
# ---------------------------------------------------------
esphome:
  name: "esp-eink-eg-diele"
  friendly_name: "esp-eink-eg-diele"
  on_boot:
    priority: 800
    then:
      - delay: 45s
      - script.execute: refresh_display

esp32:
  board: esp32dev
  framework:
    type: esp-idf

# ---------------------------------------------------------
# System / Communication
# ---------------------------------------------------------
logger:
  level: DEBUG
  # baud_rate: 0  # (optional) disable serial logs → faster boot

api:
  encryption:
    key: "p8NdKM2B3kH4ASNjawnEUo+nUQ6k20V1Y8Y4/u1/+7o="

ota:
  - platform: esphome
    password: "b8c22fe3b23e480d00ca5f61f8c7d294"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

time:
  - platform: homeassistant
    id: homeassistant_time

sun:
  latitude: 48.4706479
  longitude: 8.4824076

# ---------------------------------------------------------
# User actions (Buttons)
# ---------------------------------------------------------
button:
  - platform: restart
    name: "eInk-EG-Diele - Restart"

  - platform: template
    name: "eInk-EG-Diele - Refresh Screen"
    entity_category: config
    on_press:
      - component.update: eink_display

# ---------------------------------------------------------
# Scheduled actions
# ---------------------------------------------------------
interval:
  - interval: 30min
    then:
      - script.execute: refresh_display

# ---------------------------------------------------------
# Colors (panel channels depend on Waveshare model)
# ---------------------------------------------------------
color:
  - id: COLOR_TEXT
    red: 0%
    green: 0%
    blue: 0%
    white: 0%

  - id: COLOR_BG
    red: 0%
    green: 0%
    blue: 0%
    white: 100%

# ---------------------------------------------------------
# Scripts (display refresh & time-of-day color logic)
# ---------------------------------------------------------
script:
  # Refresh display between 06–23; set color theme first
  - id: refresh_display
    mode: queued
    then:
      - lambda: |-
          int hour = id(homeassistant_time).now().hour;
          if (hour >= 6 && hour <= 23) {
            id(set_display_color_by_time).execute();
            id(eink_display).update();
          }

  # Set text/background color based on time of day
  - id: set_display_color_by_time
    mode: restart
    then:
      - lambda: |-
          int hour = id(homeassistant_time).now().hour;
          if (hour >= 6 && hour < 12) {
            id(COLOR_TEXT) = Color(0, 0, 0, 0);     // White (check panel interpretation)
            id(COLOR_BG)   = Color(255, 0, 0, 0);   // Red
          } else if (hour >= 12 && hour < 20) {
            id(COLOR_TEXT) = Color(0, 0, 0, 0);     // White
            id(COLOR_BG)   = Color(0, 0, 0, 255);   // Black
          } else {
            id(COLOR_TEXT) = Color(0, 0, 0, 255);   // Black
            id(COLOR_BG)   = Color(0, 0, 0, 0);     // White
          }

# ---------------------------------------------------------
# Fonts (Gotham + MDI)
# ---------------------------------------------------------
font:
  - file: "fonts/GothamRnd-Book.ttf"
    id: font_10_book
    size: 10

  - file: "fonts/GothamRnd-Book.ttf"
    id: font_16_book
    size: 16

  - file: "fonts/GothamRnd-Book.ttf"
    id: font_30_book
    size: 30

  - file: "fonts/GothamRnd-Book.ttf"
    id: font_54_book
    size: 54

  - file: "fonts/GothamRnd-Bold.ttf"
    id: font_large_bold
    size: 54

  - file: "fonts/GothamRnd-Bold.ttf"
    id: font_medium_bold
    size: 18

  # MDI – weather glyphs (large)
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: font_150_mdi
    size: 140
    glyphs: &mdi-weather-glyphs
      - "\U000F0590" # mdi-weather-cloudy
      - "\U000F0F2F" # mdi-weather-cloudy-alert
      - "\U000F0E6E" # mdi-weather-cloudy-arrow-right
      - "\U000F0591" # mdi-weather-fog
      - "\U000F0592" # mdi-weather-hail
      - "\U000F0F30" # mdi-weather-hazy
      - "\U000F0898" # mdi-weather-hurricane
      - "\U000F0593" # mdi-weather-lightning
      - "\U000F067E" # mdi-weather-lightning-rainy
      - "\U000F0594" # mdi-weather-night
      - "\U000F0F31" # mdi-weather-night-partly-cloudy
      - "\U000F0595" # mdi-weather-partly-cloudy
      - "\U000F0F32" # mdi-weather-partly-lightning
      - "\U000F0F33" # mdi-weather-partly-rainy
      - "\U000F0F34" # mdi-weather-partly-snowy
      - "\U000F0F35" # mdi-weather-partly-snowy-rainy
      - "\U000F0596" # mdi-weather-pouring
      - "\U000F0597" # mdi-weather-rainy
      - "\U000F0598" # mdi-weather-snowy
      - "\U000F0F36" # mdi-weather-snowy-heavy
      - "\U000F067F" # mdi-weather-snowy-rainy
      - "\U000F0599" # mdi-weather-sunny
      - "\U000F0F37" # mdi-weather-sunny-alert
      - "\U000F14E4" # mdi-weather-sunny-off
      - "\U000F059A" # mdi-weather-sunset
      - "\U000F059B" # mdi-weather-sunset-down
      - "\U000F059C" # mdi-weather-sunset-up
      - "\U000F0F38" # mdi-weather-tornado
      - "\U000F059D" # mdi-weather-windy
      - "\U000F059E" # mdi-weather-windy-variant

  # MDI – weather glyphs (medium)
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: font_100_mdi
    size: 100
    glyphs: *mdi-weather-glyphs

  # MDI – extra symbols (large)
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: font_54_mdi
    size: 54
    glyphs:
      - "\U000F058E" # mdi-water-percent
      - "\U000F050F" # mdi-thermometer
      - "\U000F1A5F" # mdi-pool-thermometer
      - "\U000F06CC" # mdi-delete-empty

  # MDI – extra symbols (small)
  - file: "fonts/materialdesignicons-webfont.ttf"
    id: font_22_mdi
    size: 22
    glyphs:
      - "\U000F059C" # mdi-weather-sunset-up
      - "\U000F059B" # mdi-weather-sunset-down
      - "\U000F050F" # mdi-thermometer
      - "\U000F0596" # mdi-weather-pouring
      - "\U000F059D" # mdi-weather-windy
      - "\U000F0F38" # mdi-weather-tornado
      - "\U000F0143" # mdi-chevron-up
      - "\U000F0140" # mdi-chevron-down
      - "\U000F0026" # mdi-alert

# ---------------------------------------------------------
# Sensors (numeric)
# ---------------------------------------------------------
sensor:
  - platform: wifi_signal
    id: wifisignal
    name: "eInk-EG-Diele - WiFi Signal Strength"
    unit_of_measurement: "dBm"
    entity_category: diagnostic
    update_interval: 60s

  - platform: homeassistant
    entity_id: sensor.temp_aussen_low
    id: out_temp

  - platform: homeassistant
    entity_id: sensor.ads_wetterhum
    id: out_hum

  - platform: homeassistant
    entity_id: sensor.freudenstadt_uv_index
    id: out_uv

  - platform: homeassistant
    entity_id: sensor.forecast_weather_max_temp_today
    id: temp_max_today

  - platform: homeassistant
    entity_id: sensor.forecast_weather_min_temp_today
    id: temp_min_today

  - platform: homeassistant
    entity_id: sensor.ibs_th2_p01b_00f0_temperature
    id: temp_pool

# ---------------------------------------------------------
# Text sensors (strings)
# ---------------------------------------------------------
text_sensor:
  # --- Date / current weather condition ---
  - platform: homeassistant
    entity_id: sensor.weekday_german
    id: weekday

  - platform: homeassistant
    entity_id: sensor.date_german
    id: date

  - platform: homeassistant
    entity_id: weather.freudenstadt
    id: weather_condition_now

  # --- Sun times (text format) ---
  - platform: sun
    id: next_sunrise
    type: sunrise

  - platform: sun
    id: next_sunset
    type: sunset

  # --- Forecast: +4h ---
  - platform: homeassistant
    entity_id: sensor.forecast_4h_timestamp
    id: forecast_4h_timestamp

  - platform: homeassistant
    entity_id: sensor.forecast_4h_condition
    id: forecast_4h_condition

  - platform: homeassistant
    entity_id: sensor.forecast_4h_temperature
    id: forecast_4h_temp

  - platform: homeassistant
    entity_id: sensor.forecast_4h_precipitation
    id: forecast_4h_precipitation

  - platform: homeassistant
    entity_id: sensor.forecast_4h_wind_speed
    id: forecast_4h_wind_speed

  - platform: homeassistant
    entity_id: sensor.forecast_4h_wind_gust_speed
    id: forecast_4h_wind_gust_speed

  # --- Forecast: +8h ---
  - platform: homeassistant
    entity_id: sensor.forecast_8h_timestamp
    id: forecast_8h_timestamp

  - platform: homeassistant
    entity_id: sensor.forecast_8h_condition
    id: forecast_8h_condition

  - platform: homeassistant
    entity_id: sensor.forecast_8h_temperature
    id: forecast_8h_temp

  - platform: homeassistant
    entity_id: sensor.forecast_8h_precipitation
    id: forecast_8h_precipitation

  - platform: homeassistant
    entity_id: sensor.forecast_8h_wind_speed
    id: forecast_8h_wind_speed

  - platform: homeassistant
    entity_id: sensor.forecast_8h_wind_gust_speed
    id: forecast_8h_wind_gust_speed

  # --- Forecast: +12h ---
  - platform: homeassistant
    entity_id: sensor.forecast_12h_timestamp
    id: forecast_12h_timestamp

  - platform: homeassistant
    entity_id: sensor.forecast_12h_condition
    id: forecast_12h_condition

  - platform: homeassistant
    entity_id: sensor.forecast_12h_temperature
    id: forecast_12h_temp

  - platform: homeassistant
    entity_id: sensor.forecast_12h_precipitation
    id: forecast_12h_precipitation

  - platform: homeassistant
    entity_id: sensor.forecast_12h_wind_speed
    id: forecast_12h_wind_speed

  - platform: homeassistant
    entity_id: sensor.forecast_12h_wind_gust_speed
    id: forecast_12h_wind_gust_speed

  # --- Today: rain & wind (as text from HA) ---
  - platform: homeassistant
    entity_id: sensor.forecast_weather_regen_today
    id: forecast_rain_today

  - platform: homeassistant
    entity_id: sensor.forecast_weather_wind_today
    id: forecast_wind_today

  # --- Trash pickup dates ---
  - platform: homeassistant
    entity_id: sensor.abfalltermine_heute
    id: trash_today

  - platform: homeassistant
    entity_id: sensor.abfalltermine_morgen
    id: trash_tomorrow

# ---------------------------------------------------------
# SPI / Display
# ---------------------------------------------------------
spi:
  clk_pin: GPIO13
  mosi_pin: GPIO14

display:
  - platform: waveshare_epaper
    id: eink_display
    model: 7.50in-bv3-bwr
    cs_pin: GPIO15
    dc_pin: GPIO27
    busy_pin: GPIO25
    reset_pin: GPIO26
    reset_duration: 2ms
    update_interval: never
    rotation: 90
    lambda: |-
      // -----------------------------------------------------
      // Background
      // -----------------------------------------------------
      it.fill(COLOR_BG);

      // -----------------------------------------------------
      // Weather icons map (Key ↔ MDI glyph)
      // -----------------------------------------------------
      std::map<std::string, std::string> weather_icon_map{
        {"cloudy", "\U000F0590"},
        {"cloudy-alert", "\U000F0F2F"},
        {"cloudy-arrow-right", "\U000F0E6E"},
        {"fog", "\U000F0591"},
        {"hail", "\U000F0592"},
        {"hazy", "\U000F0F30"},
        {"hurricane", "\U000F0898"},
        {"lightning", "\U000F0593"},
        {"lightning-rainy", "\U000F067E"},
        {"clear-night", "\U000F0594"},
        {"night-partly-cloudy", "\U000F0F31"},
        {"partlycloudy", "\U000F0595"},
        {"partly-lightning", "\U000F0F32"},
        {"partly-rainy", "\U000F0F33"},
        {"partly-snowy", "\U000F0F34"},
        {"partly-snowy-rainy", "\U000F0F35"},
        {"pouring", "\U000F0596"},
        {"rainy", "\U000F0597"},
        {"snowy", "\U000F0598"},
        {"snowy-heavy", "\U000F0F36"},
        {"snowy-rainy", "\U000F067F"},
        {"sunny", "\U000F0599"},
        {"sunny-alert", "\U000F0F37"},
        {"sunny-off", "\U000F14E4"},
        {"sunset", "\U000F059A"},
        {"sunset-down", "\U000F059B"},
        {"sunset-up", "\U000F059C"},
        {"tornado", "\U000F0F38"},
        {"windy", "\U000F059D"},
        {"windy-variant", "\U000F059E"},
      };

      bool data_missing = false;

      // -----------------------------------------------------
      // Helpers (pointer semantics: id(...) yields *)
      // -----------------------------------------------------
      auto check_state = [&](auto id_ref, const char *sensor_name) {
        if (!id_ref->has_state()) {
          ESP_LOGW("display", "Missing sensor value: %s", sensor_name);
          data_missing = true;
          return false;
        }
        return true;
      };

      auto valid_text = [](const std::string &s) {
        return !s.empty() && s != "unknown" && s != "unavailable";
      };

      auto has_valid = [&](auto *ts) {
        return ts != nullptr && ts->has_state() && valid_text(ts->state);
      };

      auto safe_icon = [&](auto *cond_ts) -> const char * {
        const char *key = (cond_ts != nullptr && cond_ts->has_state() && valid_text(cond_ts->state))
                            ? cond_ts->state.c_str()
                            : "unknown";
        return weather_icon_map.count(key) ? weather_icon_map[key].c_str()
                                           : weather_icon_map["cloudy"].c_str();
      };

      // -----------------------------------------------------
      // Header: date & weekday
      // -----------------------------------------------------
      if (check_state(id(date), "date"))
        it.printf(240, 30, id(font_medium_bold), COLOR_TEXT, TextAlign::TOP_CENTER, id(date).state.c_str());

      if (check_state(id(weekday), "weekday"))
        it.printf(240, 60, id(font_large_bold), COLOR_TEXT, TextAlign::TOP_CENTER, id(weekday).state.c_str());

      // -----------------------------------------------------
      // Current weather (icon)
      // -----------------------------------------------------
      std::string weather = check_state(id(weather_condition_now), "weather_condition_now")
                              ? id(weather_condition_now).state
                              : "cloudy";
      it.printf(35, 150, id(font_150_mdi), COLOR_TEXT, "%s", weather_icon_map[weather].c_str());

      // -----------------------------------------------------
      // Daily values: max/min temp, outside temp, humidity, UV
      // -----------------------------------------------------
      it.printf(270, 125, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F0143");
      if (check_state(id(temp_max_today), "temp_max_today"))
        it.printf(283, 130, id(font_16_book), COLOR_TEXT, "%2.0f°C", id(temp_max_today).state);
      else
        it.printf(283, 130, id(font_16_book), COLOR_TEXT, "--°C");

      it.printf(345, 125, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F0140");
      if (check_state(id(temp_min_today), "temp_min_today"))
        it.printf(357, 130, id(font_16_book), COLOR_TEXT, "%2.0f°C", id(temp_min_today).state);
      else
        it.printf(357, 130, id(font_16_book), COLOR_TEXT, "--°C");

      it.printf(250, 155, id(font_54_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F050F");
      if (check_state(id(out_temp), "out_temp"))
        it.printf(280, 155, id(font_large_bold), COLOR_TEXT, "%2.0f°C", id(out_temp).state);
      else
        it.printf(280, 155, id(font_large_bold), COLOR_TEXT, "--°C");

      it.printf(250, 225, id(font_54_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F058E");
      if (check_state(id(out_hum), "out_hum"))
        it.printf(280, 225, id(font_54_book), COLOR_TEXT, "%2.0f%%", id(out_hum).state);
      else
        it.printf(280, 225, id(font_54_book), COLOR_TEXT, "--%%");

      if (check_state(id(out_uv), "out_uv"))
        it.printf(80, 290, id(font_16_book), COLOR_TEXT, "UV: %2.0f", id(out_uv).state);
      else
        it.printf(80, 290, id(font_16_book), COLOR_TEXT, "UV: --");

      // -----------------------------------------------------
      // Sunrise / sunset
      // -----------------------------------------------------
      it.printf(42, 125, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F059C");
      auto sunrise = id(next_sunrise).state;
      if (sunrise.length() >= 5)
        it.printf(58, 130, id(font_16_book), COLOR_TEXT, sunrise.substr(0, 5).c_str());
      else {
        it.printf(58, 130, id(font_16_book), COLOR_TEXT, "--:--");
        ESP_LOGW("display", "Missing sensor value: next_sunrise");
        data_missing = true;
      }

      it.printf(117, 125, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F059B");
      auto sunset = id(next_sunset).state;
      if (sunset.length() >= 5)
        it.printf(133, 130, id(font_16_book), COLOR_TEXT, sunset.substr(0, 5).c_str());
      else {
        it.printf(133, 130, id(font_16_book), COLOR_TEXT, "--:--");
        ESP_LOGW("display", "Missing sensor value: next_sunset");
        data_missing = true;
      }

      // -----------------------------------------------------
      // Today: rainfall & wind speed (as text)
      // -----------------------------------------------------
      it.printf(250, 287, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F0596");
      if (check_state(id(forecast_rain_today), "forecast_rain_today"))
        it.printf(268, 290, id(font_16_book), COLOR_TEXT, "%s mm", id(forecast_rain_today).state.c_str());
      else
        it.printf(268, 290, id(font_16_book), COLOR_TEXT, "-- mm");

      it.printf(355, 287, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F059D");
      if (check_state(id(forecast_wind_today), "forecast_wind_today"))
        it.printf(372, 290, id(font_16_book), COLOR_TEXT, "%s km/h", id(forecast_wind_today).state.c_str());
      else
        it.printf(372, 290, id(font_16_book), COLOR_TEXT, "-- km/h");

      // -----------------------------------------------------
      // Divider + "Forecast" title
      // -----------------------------------------------------
      it.line(25, 320, 460, 320, COLOR_TEXT);
      it.printf(240, 340, id(font_30_book), COLOR_TEXT, TextAlign::TOP_CENTER, "Vorhersage");

      // -----------------------------------------------------
      // Forecast tiles: +4h / +8h / +12h
      //   - Time: only if timestamp valid
      //   - Icon: always (with fallback)
      //   - Values: only if valid
      // -----------------------------------------------------

      // +4h
      if (has_valid(id(forecast_4h_timestamp)) && id(forecast_4h_timestamp).state.size() >= 13) {
        it.printf(105, 390, id(font_medium_bold), COLOR_TEXT, TextAlign::TOP_CENTER,
                  "%s Uhr", id(forecast_4h_timestamp).state.substr(11, 2).c_str());
      }
      it.printf(105, 410, id(font_100_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "%s",
                safe_icon(id(forecast_4h_condition)));

      it.printf(65, 518, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F050F");
      if (has_valid(id(forecast_4h_temp)))
        it.printf(80, 522, id(font_16_book), COLOR_TEXT, "%s°C", id(forecast_4h_temp).state.c_str());

      it.printf(65, 543, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F0596");
      if (has_valid(id(forecast_4h_precipitation)))
        it.printf(80, 547, id(font_16_book), COLOR_TEXT, "%s mm", id(forecast_4h_precipitation).state.c_str());

      it.printf(65, 568, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F059D");
      if (has_valid(id(forecast_4h_wind_speed)))
        it.printf(80, 572, id(font_16_book), COLOR_TEXT, "%s km/h", id(forecast_4h_wind_speed).state.c_str());

      it.printf(65, 593, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F0F38");
      if (has_valid(id(forecast_4h_wind_gust_speed)))
        it.printf(80, 597, id(font_16_book), COLOR_TEXT, "%s km/h", id(forecast_4h_wind_gust_speed).state.c_str());

      // +8h
      if (has_valid(id(forecast_8h_timestamp)) && id(forecast_8h_timestamp).state.size() >= 13) {
        it.printf(240, 390, id(font_medium_bold), COLOR_TEXT, TextAlign::TOP_CENTER,
                  "%s Uhr", id(forecast_8h_timestamp).state.substr(11, 2).c_str());
      }
      it.printf(240, 410, id(font_100_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "%s",
                safe_icon(id(forecast_8h_condition)));

      it.printf(200, 518, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F050F");
      if (has_valid(id(forecast_8h_temp)))
        it.printf(215, 522, id(font_16_book), COLOR_TEXT, "%s°C", id(forecast_8h_temp).state.c_str());

      it.printf(200, 543, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F0596");
      if (has_valid(id(forecast_8h_precipitation)))
        it.printf(215, 547, id(font_16_book), COLOR_TEXT, "%s mm", id(forecast_8h_precipitation).state.c_str());

      it.printf(200, 568, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F059D");
      if (has_valid(id(forecast_8h_wind_speed)))
        it.printf(215, 572, id(font_16_book), COLOR_TEXT, "%s km/h", id(forecast_8h_wind_speed).state.c_str());

      it.printf(200, 593, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F0F38");
      if (has_valid(id(forecast_8h_wind_gust_speed)))
        it.printf(215, 597, id(font_16_book), COLOR_TEXT, "%s km/h", id(forecast_8h_wind_gust_speed).state.c_str());

      // +12h
      if (has_valid(id(forecast_12h_timestamp)) && id(forecast_12h_timestamp).state.size() >= 13) {
        it.printf(375, 390, id(font_medium_bold), COLOR_TEXT, TextAlign::TOP_CENTER,
                  "%s Uhr", id(forecast_12h_timestamp).state.substr(11, 2).c_str());
      }
      it.printf(375, 410, id(font_100_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "%s",
                safe_icon(id(forecast_12h_condition)));

      it.printf(335, 518, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F050F");
      if (has_valid(id(forecast_12h_temp)))
        it.printf(350, 522, id(font_16_book), COLOR_TEXT, "%s°C", id(forecast_12h_temp).state.c_str());

      it.printf(335, 543, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F0596");
      if (has_valid(id(forecast_12h_precipitation)))
        it.printf(350, 547, id(font_16_book), COLOR_TEXT, "%s mm", id(forecast_12h_precipitation).state.c_str());

      it.printf(335, 568, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F059D");
      if (has_valid(id(forecast_12h_wind_speed)))
        it.printf(350, 572, id(font_16_book), COLOR_TEXT, "%s km/h", id(forecast_12h_wind_speed).state.c_str());

      it.printf(335, 593, id(font_22_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F0F38");
      if (has_valid(id(forecast_12h_wind_gust_speed)))
        it.printf(350, 597, id(font_16_book), COLOR_TEXT, "%s km/h", id(forecast_12h_wind_gust_speed).state.c_str());

      // -----------------------------------------------------
      // Extra: pool temperature (only if available)
      // -----------------------------------------------------
      if (!isnan(id(temp_pool).state)) {
        it.printf(70, 680, id(font_54_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F1A5F");
        it.printf(105, 690, id(font_30_book), COLOR_TEXT, "%2.0f°C", id(temp_pool).state);
      }

      // -----------------------------------------------------
      // Trash pickup (today/tomorrow)
      // -----------------------------------------------------
      it.printf(225, 675, id(font_54_mdi), COLOR_TEXT, TextAlign::TOP_CENTER, "\U000F06CC");
      it.printf(255, 665, id(font_medium_bold), COLOR_TEXT, "Heute:");
      it.printf(255, 685, id(font_16_book),   COLOR_TEXT, "%s", id(trash_today).state.c_str());
      it.printf(255, 705, id(font_medium_bold), COLOR_TEXT, "Morgen:");
      it.printf(255, 725, id(font_16_book),   COLOR_TEXT, "%s", id(trash_tomorrow).state.c_str());

      // -----------------------------------------------------
      // Data issue indicator (warning icon)
      // -----------------------------------------------------
      if (data_missing) {
        it.printf(450, 20, id(font_22_mdi), COLOR_TEXT, "\U000F0026");
      }

      // -----------------------------------------------------
      // Divider & timestamp
      // -----------------------------------------------------
      it.line(25, 635, 460, 635, COLOR_TEXT);
      char str[17];
      time_t currTime = id(homeassistant_time).now().timestamp;
      strftime(str, sizeof(str), "%H:%M", localtime(&currTime));
      it.printf(240, 770, id(font_10_book), COLOR_TEXT, TextAlign::TOP_CENTER, "Letzte Aktualisierung %s", str);